<!DOCTYPE html>
<html>
<head>
  <title>Query Console v0.2.0</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <%= csrf_meta_tags %>
  <meta name="turbo-refresh-method" content="morph">
  <meta name="turbo-refresh-scroll" content="preserve">
  
  <style>
    * { box-sizing: border-box; }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      margin: 0;
      padding: 20px;
      background: #f5f5f5;
      color: #333;
    }

    .container {
      max-width: 1600px;
      margin: 0 auto;
    }

    /* Banner */
    .banner {
      background: #fff3cd;
      border: 1px solid #ffc107;
      border-radius: 4px;
      padding: 15px;
      margin-bottom: 20px;
      color: #856404;
      position: relative;
    }

    .banner.collapsed .banner-content { display: none; }
    .banner h2 {
      margin: 0 0 10px 0;
      font-size: 18px;
      padding-right: 30px;
    }
    .banner p {
      margin: 5px 0;
      font-size: 14px;
    }

    .section-toggle {
      position: absolute;
      top: 50%;
      right: 15px;
      transform: translateY(-50%);
      background: transparent;
      border: none;
      cursor: pointer;
      padding: 4px 8px;
      font-size: 16px;
    }

    /* Main Layout */
    .main-layout {
      display: grid;
      grid-template-columns: 1fr 400px;
      gap: 20px;
      align-items: start;
    }

    /* Editor Section */
    .editor-section {
      background: white;
      border-radius: 8px;
      padding: 20px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      min-width: 0; /* Allow grid to constrain this column */
      width: 100%; /* Take full grid column width */
      position: relative;
    }
    
    .editor-section.collapsed .editor-content { display: none; }

    .editor-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
      position: relative;
      padding-right: 40px; /* Increased from 30px to give more space for toggle button */
    }

    .editor-header h3 {
      margin: 0;
      font-size: 16px;
    }

    .button-group {
      display: flex;
      gap: 10px;
    }

    .btn-primary, .btn-secondary {
      padding: 8px 16px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
    }

    .btn-primary {
      background: #007bff;
      color: white;
    }

    .btn-primary:hover {
      background: #0056b3;
    }

    .btn-secondary {
      background: #6c757d;
      color: white;
    }

    .btn-secondary:hover {
      background: #545b62;
    }

    /* SQL Editor Textarea */
    .sql-editor {
      width: 100%;
      min-height: 200px;
      padding: 12px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-family: 'Monaco', 'Menlo', 'Courier New', monospace;
      font-size: 14px;
      line-height: 1.5;
      resize: vertical;
    }

    .sql-editor:focus {
      outline: none;
      border-color: #007bff;
      box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.1);
    }


    /* Results Containers - prevent horizontal expansion */
    turbo-frame#query-results,
    turbo-frame#explain-results {
      display: block;
      width: 100%;
      min-width: 0;
      overflow-x: auto;
    }

    /* Right Panel */
    .right-panel {
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    /* Tabbed Section */
    .tabbed-section {
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      overflow: hidden;
    }
    
    .tabbed-section.collapsed .tab-content { display: none; }

    .tabs {
      display: flex;
      border-bottom: 1px solid #dee2e6;
      background: #f8f9fa;
    }

    .tab {
      padding: 12px 20px;
      cursor: pointer;
      border: none;
      background: transparent;
      border-bottom: 2px solid transparent;
      font-size: 14px;
      font-weight: 500;
    }

    .tab.active {
      border-bottom-color: #007bff;
      color: #007bff;
    }

    .tab-content {
      padding: 15px;
      max-height: 400px;
      overflow-y: auto;
    }

    .tab-pane {
      display: none;
    }

    .tab-pane.active {
      display: block;
    }

    /* History & Schema Lists */
    ul.item-list {
      list-style: none;
      padding: 0;
      margin: 0;
    }

    ul.item-list li {
      padding: 10px;
      border-bottom: 1px solid #eee;
      cursor: pointer;
    }

    ul.item-list li:hover {
      background: #f8f9fa;
    }

    /* Saved Queries Section */
    .saved-section {
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      padding: 15px;
    }

    .saved-section.collapsed .saved-content {
      display: none;
    }

    .saved-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }

    .saved-header h4 {
      margin: 0;
      font-size: 14px;
    }

    .saved-query-item {
      padding: 10px;
      border: 1px solid #dee2e6;
      border-radius: 4px;
      margin-bottom: 8px;
    }

    .saved-query-item:hover {
      background: #f8f9fa;
    }

    /* Schema Explorer */
    .schema-search {
      width: 100%;
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
      margin-bottom: 10px;
    }

    .table-item {
      padding: 8px;
      cursor: pointer;
      border-bottom: 1px solid #eee;
    }

    .table-item:hover {
      background: #f8f9fa;
    }

    .columns-list {
      margin-top: 10px;
      padding-left: 15px;
    }

    .column-item {
      padding: 6px;
      font-size: 13px;
      border-left: 2px solid #007bff;
      margin-bottom: 4px;
      background: #f8f9fa;
    }

    /* Quick Actions */
    .quick-actions {
      display: flex;
      gap: 6px;
      margin-top: 6px;
    }

    .quick-action-btn {
      padding: 4px 8px;
      font-size: 11px;
      background: #e9ecef;
      border: 1px solid #dee2e6;
      border-radius: 3px;
      cursor: pointer;
    }

    .quick-action-btn:hover {
      background: #dee2e6;
    }

    /* Results */
    .results-container {
      margin-top: 20px;
    }

    .table-wrapper {
      overflow: auto;
      border: 1px solid #dee2e6;
      border-radius: 4px;
      max-height: 500px;
    }

    .results-table {
      width: 100%;
      border-collapse: collapse;
    }

    .results-table thead {
      position: sticky;
      top: 0;
      background: #f8f9fa;
      z-index: 10;
    }

    .results-table th,
    .results-table td {
      padding: 8px 12px;
      text-align: left;
      border: 1px solid #dee2e6;
      white-space: nowrap;
    }

    .results-table th {
      font-weight: 600;
      background: #e9ecef;
    }
  </style>

  <script type="importmap">
    {
      "imports": {
        "@hotwired/turbo-rails": "https://cdn.jsdelivr.net/npm/@hotwired/turbo@8.0.4/dist/turbo.es2017-esm.min.js",
        "@hotwired/stimulus": "https://cdn.jsdelivr.net/npm/@hotwired/stimulus@3.2.2/dist/stimulus.min.js"
      }
    }
  </script>

  <script type="module">
    import * as Turbo from "@hotwired/turbo-rails"
    import { Application, Controller } from "@hotwired/stimulus"

    const application = Application.start()

    // Collapsible Controller
    class CollapsibleController extends Controller {
      static values = { key: String }
      
      connect() {
        this.loadState()
      }
      
      toggle() {
        this.element.classList.toggle('collapsed')
        this.saveState()
      }
      
      loadState() {
        const key = this.keyValue
        const collapsed = localStorage.getItem(`qc.collapsed.${key}`) === 'true'
        if (collapsed) {
          this.element.classList.add('collapsed')
        }
      }
      
      saveState() {
        const key = this.keyValue
        const collapsed = this.element.classList.contains('collapsed')
        localStorage.setItem(`qc.collapsed.${key}`, collapsed)
      }
    }
    application.register("collapsible", CollapsibleController)

    // Tabs Controller
    class TabsController extends Controller {
      static targets = ["tab", "pane"]
      
      connect() {
        this.showTab(0)
      }
      
      select(event) {
        const index = this.tabTargets.indexOf(event.currentTarget)
        this.showTab(index)
      }
      
      showTab(index) {
        this.tabTargets.forEach((tab, i) => {
          tab.classList.toggle('active', i === index)
        })
        this.paneTargets.forEach((pane, i) => {
          pane.classList.toggle('active', i === index)
        })
      }
    }
    application.register("tabs", TabsController)

    // Editor Controller (Simple Textarea)
    class EditorController extends Controller {
      static targets = ["textarea"]
      
      getSql() {
        return this.textareaTarget.value
      }
      
      setSql(text) {
        this.textareaTarget.value = text
        this.textareaTarget.focus()
      }
      
      insertAtCursor(text) {
        const textarea = this.textareaTarget
        const start = textarea.selectionStart
        const end = textarea.selectionEnd
        const before = textarea.value.substring(0, start)
        const after = textarea.value.substring(end)
        
        textarea.value = before + text + after
        textarea.selectionStart = textarea.selectionEnd = start + text.length
        textarea.focus()
      }
      
      clearEditor() {
        this.textareaTarget.value = ''
        this.textareaTarget.focus()
        
        // Clear query results
        const queryFrame = document.querySelector('turbo-frame#query-results')
        if (queryFrame) {
          queryFrame.innerHTML = '<div style="color: #6c757d; text-align: center; padding: 40px; margin-top: 20px;"><p>Enter a query above and click "Run Query" to see results here.</p></div>'
        }
        
        // Clear explain results
        const explainFrame = document.querySelector('turbo-frame#explain-results')
        if (explainFrame) {
          explainFrame.innerHTML = ''
        }
      }
      
      runQuery() {
        const sql = this.getSql()
        if (!sql.trim()) {
          alert('Please enter a SQL query')
          return
        }
        
        // Clear explain results when running query
        const explainFrame = document.querySelector('turbo-frame#explain-results')
        if (explainFrame) {
          explainFrame.innerHTML = ''
        }
        
        // Store for history
        window._lastExecutedSQL = sql
        
        // Create form with Turbo Frame target
        const form = document.createElement('form')
        form.method = 'POST'
        form.action = '<%= query_console.run_path %>'
        form.setAttribute('data-turbo-frame', 'query-results')
        form.innerHTML = `
          <input type="hidden" name="sql" value="${sql.replace(/"/g, '&quot;')}">
          <input type="hidden" name="authenticity_token" value="${document.querySelector('meta[name=csrf-token]').content}">
        `
        document.body.appendChild(form)
        form.requestSubmit()
        document.body.removeChild(form)
      }
      
      explainQuery() {
        const sql = this.getSql()
        if (!sql.trim()) {
          alert('Please enter a SQL query')
          return
        }
        
        // Clear query results when running explain
        const queryFrame = document.querySelector('turbo-frame#query-results')
        if (queryFrame) {
          queryFrame.innerHTML = ''
        }
        
        // Create form with Turbo Frame target
        const form = document.createElement('form')
        form.method = 'POST'
        form.action = '<%= query_console.explain_path %>'
        form.setAttribute('data-turbo-frame', 'explain-results')
        form.innerHTML = `
          <input type="hidden" name="sql" value="${sql.replace(/"/g, '&quot;')}">
          <input type="hidden" name="authenticity_token" value="${document.querySelector('meta[name=csrf-token]').content}">
        `
        document.body.appendChild(form)
        form.requestSubmit()
        document.body.removeChild(form)
      }
    }
    application.register("editor", EditorController)

    // Schema Controller
    class SchemaController extends Controller {
      static targets = ["search", "tablesList", "details"]
      
      connect() {
        this.loadTables()
      }
      
      async loadTables() {
        try {
          const response = await fetch('<%= query_console.schema_tables_path %>')
          this.tables = await response.json()
          this.renderTables()
        } catch (error) {
          console.error('Failed to load tables:', error)
        }
      }
      
      filterTables(event) {
        const query = event.target.value.toLowerCase()
        this.renderTables(query)
      }
      
      renderTables(filter = '') {
        const filtered = filter ? 
          this.tables.filter(t => t.name.toLowerCase().includes(filter)) : 
          this.tables
        
        this.tablesListTarget.innerHTML = filtered.map(table => 
          `<div class="table-item" data-action="click->schema#selectTable" data-table-name="${table.name}">
            üìä ${table.name} <small>(${table.kind})</small>
          </div>`
        ).join('')
      }
      
      async selectTable(event) {
        const tableName = event.currentTarget.dataset.tableName
        
        try {
          const response = await fetch(`<%= query_console.schema_tables_path %>/${tableName}`)
          const tableData = await response.json()
          this.renderTableDetails(tableData)
        } catch (error) {
          console.error('Failed to load table details:', error)
        }
      }
      
      renderTableDetails(table) {
        const editor = this.application.getControllerForElementAndIdentifier(
          document.querySelector('[data-controller="editor"]'),
          'editor'
        )
        
        this.detailsTarget.innerHTML = `
          <h5>${table.name}</h5>
          <div class="quick-actions">
            <button class="quick-action-btn" data-action="click->schema#insertSelectAll" data-table="${table.name}">
              SELECT * FROM ${table.name}
            </button>
            <button class="quick-action-btn" data-action="click->schema#copyTableName" data-table="${table.name}">
              üìã Copy Table Name
            </button>
          </div>
          <div class="columns-list">
            ${table.columns.map(col => `
              <div class="column-item">
                <strong>${col.name}</strong> <code>${col.db_type}</code>
                ${col.nullable ? '<span>NULL</span>' : '<span>NOT NULL</span>'}
                <div class="quick-actions">
                  <button class="quick-action-btn" data-action="click->schema#insertColumn" data-column="${col.name}">
                    Insert
                  </button>
                  <button class="quick-action-btn" data-action="click->schema#insertWhere" data-column="${col.name}">
                    WHERE
                  </button>
                </div>
              </div>
            `).join('')}
          </div>
        `
      }
      
      insertSelectAll(event) {
        const table = event.currentTarget.dataset.table
        const editor = this.getEditor()
        editor.setSql(`SELECT * FROM ${table} LIMIT 100;`)
      }
      
      insertColumn(event) {
        const column = event.currentTarget.dataset.column
        const editor = this.getEditor()
        editor.insertAtCursor(column)
      }
      
      insertWhere(event) {
        const column = event.currentTarget.dataset.column
        const editor = this.getEditor()
        editor.insertAtCursor(`WHERE ${column} = `)
      }
      
      copyTableName(event) {
        const table = event.currentTarget.dataset.table
        navigator.clipboard.writeText(table)
        alert(`Copied: ${table}`)
      }
      
      getEditor() {
        return this.application.getControllerForElementAndIdentifier(
          document.querySelector('[data-controller~="editor"]'),
          'editor'
        )
      }
    }
    application.register("schema", SchemaController)

    // History Controller
    class HistoryController extends Controller {
      static targets = ["list"]
      static values = {
        storageKey: { type: String, default: "query_console.history.v1" },
        maxItems: { type: Number, default: 20 }
      }
      
      connect() {
        this.render()
        document.addEventListener('editor:executed', (e) => this.addQuery(e.detail.sql))
      }
      
      addQuery(sql) {
        const history = this.getHistory()
        history.unshift({
          sql: sql,
          timestamp: new Date().toISOString()
        })
        
        if (history.length > this.maxItemsValue) {
          history.pop()
        }
        
        this.saveHistory(history)
        this.render()
      }
      
      render() {
        const history = this.getHistory()
        this.listTarget.innerHTML = history.length ? 
          history.map((item, index) => `
            <li data-action="click->history#load" data-index="${index}">
              <div style="font-size: 12px; color: #6c757d;">${new Date(item.timestamp).toLocaleString()}</div>
              <div style="font-size: 13px; margin-top: 4px;">${this.truncate(item.sql, 100)}</div>
            </li>
          `).join('') :
          '<li style="color: #6c757d; text-align: center; padding: 20px;">No query history</li>'
      }
      
      load(event) {
        const index = parseInt(event.currentTarget.dataset.index)
        const history = this.getHistory()
        const query = history[index]
        
        if (query) {
          const editor = this.getEditor()
          editor.setSql(query.sql)
        }
      }
      
      getEditor() {
        return this.application.getControllerForElementAndIdentifier(
          document.querySelector('[data-controller~="editor"]'),
          'editor'
        )
      }
      
      clear() {
        if (confirm('Clear all query history?')) {
          localStorage.removeItem(this.storageKeyValue)
          this.render()
        }
      }
      
      getHistory() {
        const stored = localStorage.getItem(this.storageKeyValue)
        return stored ? JSON.parse(stored) : []
      }
      
      saveHistory(history) {
        localStorage.setItem(this.storageKeyValue, JSON.stringify(history))
      }
      
      truncate(str, length) {
        return str.length > length ? str.substring(0, length) + '...' : str
      }
    }
    application.register("history", HistoryController)

    // Saved Queries Controller
    class SavedController extends Controller {
      static targets = ["list"]
      static values = {
        storageKey: { type: String, default: "query_console.saved.v1" }
      }
      
      connect() {
        this.render()
      }
      
      save() {
        const editor = this.getEditor()
        const sql = editor.getSql()
        
        if (!sql.trim()) {
          alert('Nothing to save')
          return
        }
        
        const name = prompt('Query name:')
        if (!name) return
        
        const tags = prompt('Tags (comma-separated, optional):')
        
        const saved = this.getSaved()
        saved.push({
          id: Date.now().toString(),
          name: name,
          tags: tags ? tags.split(',').map(t => t.trim()) : [],
          sql: sql,
          createdAt: new Date().toISOString(),
          updatedAt: new Date().toISOString()
        })
        
        this.saveSaved(saved)
        this.render()
      }
      
      load(event) {
        const id = event.currentTarget.dataset.id
        const saved = this.getSaved()
        const query = saved.find(q => q.id === id)
        
        if (query) {
          const editor = this.getEditor()
          editor.setSql(query.sql)
        }
      }
      
      delete(event) {
        if (!confirm('Delete this saved query?')) return
        
        const id = event.currentTarget.dataset.id
        const saved = this.getSaved().filter(q => q.id !== id)
        this.saveSaved(saved)
        this.render()
      }
      
      exportJSON() {
        const saved = this.getSaved()
        const json = JSON.stringify(saved, null, 2)
        navigator.clipboard.writeText(json)
        alert('Saved queries copied to clipboard!')
      }
      
      importJSON() {
        const json = prompt('Paste saved queries JSON:')
        if (!json) return
        
        try {
          const imported = JSON.parse(json)
          const saved = this.getSaved()
          this.saveSaved([...saved, ...imported])
          this.render()
          alert(`Imported ${imported.length} queries`)
        } catch (error) {
          alert('Invalid JSON: ' + error.message)
        }
      }
      
      render() {
        const saved = this.getSaved()
        this.listTarget.innerHTML = saved.length ?
          saved.map(query => `
            <div class="saved-query-item">
              <strong>${query.name}</strong>
              ${query.tags.length ? `<div><small>üè∑ ${query.tags.join(', ')}</small></div>` : ''}
              <div style="font-size: 12px; color: #6c757d; margin: 4px 0;">
                ${new Date(query.updatedAt).toLocaleString()}
              </div>
              <div class="quick-actions">
                <button class="quick-action-btn" data-action="click->saved#load" data-id="${query.id}">Load</button>
                <button class="quick-action-btn" data-action="click->saved#delete" data-id="${query.id}">Delete</button>
              </div>
            </div>
          `).join('') :
          '<div style="color: #6c757d; text-align: center; padding: 20px;">No saved queries</div>'
      }
      
      getSaved() {
        const stored = localStorage.getItem(this.storageKeyValue)
        return stored ? JSON.parse(stored) : []
      }
      
      saveSaved(saved) {
        localStorage.setItem(this.storageKeyValue, JSON.stringify(saved))
      }
      
      getEditor() {
        return this.application.getControllerForElementAndIdentifier(
          document.querySelector('[data-controller~="editor"]'),
          'editor'
        )
      }
    }
    application.register("saved", SavedController)
  </script>
</head>
<body>
  <div class="container">
    <!-- Banner -->
    <div class="banner" data-controller="collapsible" data-collapsible-key-value="banner">
      <h2>üîç Read-Only SQL Query Console <small>v0.2.0</small></h2>
      <div class="banner-content">
        <p><strong>Security:</strong> Read-only SELECT & WITH queries only. All queries are logged.</p>
        <p><strong>New in v0.2.0:</strong> EXPLAIN query plans, Interactive Schema Explorer with quick insert buttons, Saved Queries with tags, import/export, and localStorage-based Query History!</p>
      </div>
      <button class="section-toggle" data-action="click->collapsible#toggle" type="button">‚ñº</button>
    </div>

    <div class="main-layout">
      <!-- Editor Section -->
      <div class="editor-section" data-controller="editor collapsible" data-collapsible-key-value="editor_section">
        <div class="editor-header">
          <h3>SQL Editor</h3>
          <div class="button-group">
            <button class="btn-secondary" data-action="click->editor#clearEditor" type="button">Clear</button>
            <button class="btn-secondary" data-action="click->editor#explainQuery" type="button">‚ö° Explain</button>
            <button class="btn-primary" data-action="click->editor#runQuery" type="button">‚ñ∂ Run Query</button>
          </div>
          <button class="section-toggle" data-action="click->collapsible#toggle" title="Toggle editor" type="button">‚ñº</button>
        </div>

        <div class="editor-content" data-collapsible-target="content">
        <!-- SQL Editor -->
        <textarea
          data-editor-target="textarea"
          class="sql-editor"
          placeholder="Enter your SELECT or WITH query here...

Examples:
  SELECT * FROM users LIMIT 10;
  SELECT id, name, email FROM users WHERE active = true;
  
Use the Schema Explorer to discover tables and columns!">SELECT * FROM users LIMIT 10;</textarea>

        <!-- Results Area -->
        <%= turbo_frame_tag "query-results" do %>
          <div style="color: #6c757d; text-align: center; padding: 40px; margin-top: 20px;">
            <p>Enter a query above and click "Run Query" to see results here.</p>
          </div>
        <% end %>

        <!-- Explain Results Area -->
        <%= turbo_frame_tag "explain-results" do %>
        <% end %>
        </div>
      </div>

      <!-- Right Panel -->
      <div class="right-panel">
        <!-- Tabbed Section (History / Schema / Saved Queries) -->
        <div class="tabbed-section" data-controller="tabs collapsible" data-collapsible-key-value="tabs_section">
          <div class="tabs" style="position: relative;">
            <button class="tab" data-tabs-target="tab" data-action="click->tabs#select" type="button">üìú History</button>
            <button class="tab" data-tabs-target="tab" data-action="click->tabs#select" type="button">üìä Schema</button>
            <button class="tab" data-tabs-target="tab" data-action="click->tabs#select" type="button">üíæ Saved</button>
            <button class="section-toggle" data-action="click->collapsible#toggle" title="Toggle tabs" type="button" style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); background: transparent; border: none; cursor: pointer; padding: 4px 8px; font-size: 14px;">‚ñº</button>
          </div>

          <div class="tab-content" data-collapsible-target="content">
            <!-- History Tab -->
            <div class="tab-pane" data-tabs-target="pane">
              <div data-controller="history">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                  <h4 style="margin: 0; font-size: 14px;">Recent Queries</h4>
                  <button class="quick-action-btn" data-action="click->history#clear" type="button">Clear</button>
                </div>
                <ul class="item-list" data-history-target="list"></ul>
              </div>
            </div>

            <!-- Schema Tab -->
            <div class="tab-pane" data-tabs-target="pane">
              <div data-controller="schema">
                <input 
                  type="text" 
                  class="schema-search" 
                  placeholder="üîç Search tables..."
                  data-schema-target="search"
                  data-action="input->schema#filterTables">
                <div data-schema-target="tablesList"></div>
                <div data-schema-target="details" style="margin-top: 15px;"></div>
              </div>
            </div>

            <!-- Saved Queries Tab -->
            <div class="tab-pane" data-tabs-target="pane">
              <div data-controller="saved">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                  <h4 style="margin: 0; font-size: 14px;">Saved Queries</h4>
                  <div style="display: flex; gap: 5px;">
                    <button class="quick-action-btn" data-action="click->saved#save" type="button">üíæ Save</button>
                    <button class="quick-action-btn" data-action="click->saved#exportJSON" type="button">üì§ Export</button>
                    <button class="quick-action-btn" data-action="click->saved#importJSON" type="button">üì• Import</button>
                  </div>
                </div>
                <div data-saved-target="list"></div>
              </div>
            </div>
          </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Track query execution for history
    document.addEventListener('turbo:submit-end', (event) => {
      if (window._lastExecutedSQL) {
        document.dispatchEvent(new CustomEvent('editor:executed', {
          detail: {
            sql: window._lastExecutedSQL,
            timestamp: new Date().toISOString()
          }
        }))
        delete window._lastExecutedSQL
      }
    })
  </script>
</body>
</html>
